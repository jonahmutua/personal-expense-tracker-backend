name: Deploy Spring Boot App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_IP: ${{ secrets.VPS_IP }}
          APP_PATH: ${{ secrets.APP_PATH }}
        run: |
          ssh -o ConnectTimeout=10 $VPS_USER@$VPS_IP << 'EOF'
          set -e
          echo "=== Deployment Log ===" 
          echo "Time: $(date)" 
          echo "User: $(whoami)"
          
          APP_PATH="${APP_PATH}"
          
          # Initialize git if not already a repo
          if [ ! -d "$APP_PATH/.git" ]; then
            echo "=== Initializing git repository ==="
            mkdir -p "$APP_PATH"
            cd "$APP_PATH"
            git init
            git remote add origin https://github.com/jonahmutua/personal-expense-tracker-backend.git
            git branch -M main
            git config user.email "deploy@example.com"
            git config user.name "Deploy Bot"
          else
            cd "$APP_PATH"
          fi
          
          echo "Changed to: $(pwd)"
          git config --global --add safe.directory "$APP_PATH"
          echo "Git config updated"
          
          echo "=== Stashing local changes ==="
          git stash
          
          echo "=== Before git pull ==="
          git log --oneline -1
          
          echo "=== Running git pull ==="
          git pull || { echo "FAILED: git pull failed"; exit 1; }
          
          echo "=== After git pull ==="
          git log --oneline -1
          
          echo "=== Running gradle build ==="
          ./gradlew clean build -x test 2>&1 || { echo "FAILED: Build failed"; exit 1; }
          
          echo "=== Build artifacts ==="
          ls -lh build/libs/
          
          echo "=== Locating JAR file ==="
          JAR_FILE=$(ls build/libs/*SNAPSHOT.jar | grep -v plain)
          echo "JAR file: $JAR_FILE"
          
          if [ ! -f "$JAR_FILE" ]; then
            echo "FAILED: JAR not found at $JAR_FILE"
            exit 1
          fi
          echo "âœ“ JAR verified"
          
          echo "=== Copying JAR ==="
          mkdir -p lib
          cp "$JAR_FILE" lib/SpringBootRestExpenseTracker-1.0-SNAPSHOT.jar
          
          echo "=== Deployed JAR ==="
          ls -lh lib/SpringBootRestExpenseTracker-1.0-SNAPSHOT.jar
          
          echo "=== Restarting service ==="
          sudo systemctl restart expensesapp || { echo "FAILED: systemctl restart failed"; exit 1; }
          
          sleep 2
          
          echo "=== Service status ==="
          sudo systemctl status expensesapp
          
          echo "=== Service logs ==="
          sudo journalctl -u expensesapp -n 20
          
          echo "=== Deployment completed successfully ==="
          EOF