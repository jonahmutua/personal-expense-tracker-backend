name: Deploy Spring Boot App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}

      - name: Add VPS to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.VPS_IP }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_IP: ${{ secrets.VPS_IP }}
          APP_PATH: ${{ secrets.APP_PATH }}
        run: |
          ssh -o ConnectTimeout=10 $VPS_USER@$VPS_IP << 'EOF'
          set -e
          
          echo "=== Deployment Started ==="
          echo "Time: $(date)"
          echo "User: $(whoami)"
          
          APP_PATH="${APP_PATH}"
          cd "$APP_PATH" || { echo "ERROR: Cannot cd to $APP_PATH"; exit 1; }
          echo "Working directory: $(pwd)"
          
          # Configure git
          git config --global --add safe.directory "$APP_PATH"
          
          # Update code
          echo "=== Pulling latest code ==="
          git stash
          git pull origin main
          echo "✓ Code pulled successfully"
          
          # Build
          echo "=== Building application ==="
          ./gradlew clean build -x test
          echo "✓ Build successful"
          
          # Deploy JAR
          echo "=== Deploying JAR ==="
          JAR_FILE=$(ls build/libs/*SNAPSHOT.jar | grep -v plain)
          
          if [ ! -f "$JAR_FILE" ]; then
            echo "ERROR: JAR file not found"
            exit 1
          fi
          
          mkdir -p lib
          cp "$JAR_FILE" lib/SpringBootRestExpenseTracker-1.0-SNAPSHOT.jar
          echo "✓ JAR deployed: $(ls -lh lib/SpringBootRestExpenseTracker-1.0-SNAPSHOT.jar | awk '{print $5, $9}')"
          
          # Restart service
          echo "=== Restarting service ==="
          sudo systemctl restart expensesapp
          sleep 2
          
          # Verify
          echo "=== Verifying deployment ==="
          sudo systemctl is-active expensesapp && echo "✓ Service is running" || echo "ERROR: Service failed to start"
          
          echo "=== Recent logs ==="
          sudo journalctl -u expensesapp -n 10
          
          echo ""
          echo "=== Deployment Completed Successfully ==="
          EOF